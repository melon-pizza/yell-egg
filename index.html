<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yell Egg</title>

<style>
body { font-family:sans-serif; background:#f9f9f9; text-align:center; padding:20px }
.container { max-width:500px; margin:auto }
.card { background:#fff; border-radius:15px; padding:15px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,.1) }
video,img { width:100%; border-radius:10px }
button { background:#ff6b6b; color:#fff; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer }
.egg img { width:120px }

/* é€²åŒ–æ¼”å‡º */
.evolve { animation: evolvePop 1s ease-out }
@keyframes evolvePop {
  0% { transform: scale(0.2); opacity:0 }
  40% { transform: scale(1.4); opacity:1 }
  100% { transform: scale(1) }
}
.evolve-glow { box-shadow:0 0 30px rgba(255,255,255,.8) }

.menu { display:flex; gap:10px; justify-content:center; margin-bottom:15px }
.menu button { background:#6bcfff }
</style>
</head>

<body>
<div class="container">
<h1>Yell Egg ğŸ¥š</h1>

<div class="menu">
  <button onclick="showAbout()">ğŸ¥š ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</button>
  <button onclick="showHow()">ğŸ“£ ã‚ãã³ã‹ãŸ</button>
  <button onclick="location.href='collection.html'">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</button>
</div>

<div id="about" style="display:none" class="card">
  <h2>ğŸ¥š ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</h2>
  <p>ã‚¨ãƒ¼ãƒ«ã‚’é€ã‚‹ã¨åµãŒé³¥ã«é€²åŒ–ã™ã‚‹å¿œæ´ã‚¢ãƒ—ãƒªã§ã™ã€‚</p>
</div>

<div id="how" style="display:none" class="card">
  <h2>ğŸ“£ ã‚ãã³ã‹ãŸ</h2>
  <ol style="text-align:left">
    <li>ç”»åƒã‚„å‹•ç”»ã‚’æŠ•ç¨¿</li>
    <li>è¦‹ãŸäººãŒã‚¨ãƒ¼ãƒ«ã‚’é€ã‚‹</li>
    <li>åµãŒé³¥ã«é€²åŒ–ï¼</li>
    <li>æ§˜ã€…ãªé³¥ã‚’ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã—ã‚ˆã†â€¼</li>
  </ol>
</div>

<div id="app" style="display:none">
  <input type="file" id="file" accept="image/*,video/*">
  <br><br>
  <button id="post">æŠ•ç¨¿ã™ã‚‹</button>
  <div id="feed"></div>
</div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://omabtauqfkswkpyyyttf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYWJ0YXVxZmtzd2tweXl5dHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDQ1MjIsImV4cCI6MjA4MjU4MDUyMn0.sm-zKUJjMz3aJjiKqAUDRwnuJyjwP0FFDO-SvFCBgjQ"
);

/* ===== DOM ===== */
const app  = document.getElementById("app");
const postBtn = document.getElementById("post");
const file = document.getElementById("file");
const feed = document.getElementById("feed");

/* ===== ç”»åƒ ===== */
const BASE = "https://omabtauqfkswkpyyyttf.supabase.co/storage/v1/object/public/media";

const eggImages = {
  red:   `${BASE}/egg_red.png`,
  blue:  `${BASE}/egg_blue.png`,
  green: `${BASE}/egg_green.png`,
  yellow:`${BASE}/egg_yellow.png`,
  black: `${BASE}/egg_black.png`
};

const birdImages = {
  red:   `${BASE}/bird_red.png`,
  blue:  `${BASE}/bird_blue.png`,
  green: `${BASE}/bird_green.png`,
  yellow:`${BASE}/bird_yellow.png`,
  black: `${BASE}/bird_black.png`
};


/* ===== ãƒ­ã‚°ã‚¤ãƒ³ ===== */
async function init() {
  const { data:{ session } } = await supabase.auth.getSession();
  if (!session) await supabase.auth.signInAnonymously();
  app.style.display = "block";
  loadPosts();
}
init();

/* ===== æŠ•ç¨¿ ===== */
postBtn.onclick = async () => {
  const f = file.files[0];
  if (!f) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„");

  const { data:{ user } } = await supabase.auth.getUser();
  const path = `${user.id}/${Date.now()}_${f.name}`;

  await supabase.storage.from("media").upload(path, f);
  const { data:{ publicUrl } } = supabase.storage.from("media").getPublicUrl(path);

  const eggs = ["red","blue","green","yellow","black","unknown"];
  const egg = eggs[Math.floor(Math.random()*eggs.length)];

  await supabase.from("posts").insert({
    user_id:user.id,
    media_url:publicUrl,
    media_type:f.type.startsWith("video") ? "video" : "image",
    egg_type:egg,
    bird_type:null
  });

  file.value="";
  loadPosts();
};

/* ===== è¡¨ç¤º ===== */
async function loadPosts() {
  const { data:posts, error } = await supabase
    .from("posts")
    .select("*")
    .order("created_at",{ascending:false});

  if (!posts) return;

  feed.innerHTML="";

  for (const p of posts) {
    const { data:yells } = await supabase
      .from("yells")
      .select("id")
      .eq("post_id",p.id);

    const hasBird = p.bird_type && birdImages[p.bird_type];
    const imgUrl = hasBird
      ? birdImages[p.bird_type]
      : eggImages[p.egg_type] || eggImages.unknown;

    feed.innerHTML += `
      <div class="card">
        ${p.media_type==="video"
          ? `<video src="${p.media_url}" controls muted loop></video>`
          : `<img src="${p.media_url}">`}
        <div class="egg">
          <img src="${imgUrl}" class="${hasBird?'evolve evolve-glow':''}">
        </div>
        <p>${yells.length} / 1</p>
        <button onclick="sendYell('${p.id}')">ã‚¨ãƒ¼ãƒ«ã‚’é€ã‚‹ï¼</button>
      </div>
    `;
  }
}

/* ===== ã‚¨ãƒ¼ãƒ« ===== */
let sending = false;
window.sendYell = async (postId) => {
  if (sending) return;
  sending = true;

  const { data:{ user } } = await supabase.auth.getUser();

  await supabase.from("yells").insert({
    user_id:user.id,
    post_id:postId
  });

  const { data:post } = await supabase
    .from("posts")
    .select("egg_type,bird_type")
    .eq("id",postId)
    .single();

  if (!post.bird_type) {
    let bird = post.egg_type === "unknown"
      ? ["fes1","fes2","fes3"][Math.floor(Math.random()*3)]
      : post.egg_type;

    await supabase.from("posts")
      .update({ bird_type:bird })
      .eq("id",postId);
  }

  sending = false;
  loadPosts();
};

/* ===== UI ===== */
window.showAbout = ()=> {
  about.style.display = about.style.display==="none"?"block":"none";
  how.style.display="none";
};
window.showHow = ()=> {
  how.style.display = how.style.display==="none"?"block":"none";
  about.style.display="none";
};
</script>
</body>
</html>
