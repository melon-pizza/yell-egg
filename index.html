<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yell Egg</title>
<style>
body { font-family:sans-serif; background:#f9f9f9; text-align:center; padding:20px }
.container { max-width:500px; margin:auto }
.card { background:#fff; border-radius:15px; padding:15px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,.1) }
video,img { width:100%; border-radius:10px }
button { background:#ff6b6b; color:#fff; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer }
.egg img { width:100px }
/* é³¥ã«é€²åŒ–ã—ãŸç¬é–“ã®æ¼”å‡º */
.evolve {
  animation: evolve 0.8s ease-out;
}

@keyframes evolve {
  0% {
    transform: scale(0.5);
    opacity: 0;
    filter: brightness(1);
  }
  60% {
    transform: scale(1.2);
    opacity: 1;
    filter: brightness(1.5);
  }
  100% {
    transform: scale(1);
    filter: brightness(1);
  }
}

.menu {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 15px;
}

.menu button {
  background: #6bcfff;
}

/* é€²åŒ–æ¼”å‡ºï¼ˆæœ¬æ°—ï¼‰ */
.evolve {
  animation: evolvePop 1s ease-out;
}

@keyframes evolvePop {
  0% {
    transform: scale(0.2) rotate(-10deg);
    opacity: 0;
    filter: brightness(0.5);
  }
  40% {
    transform: scale(1.4) rotate(5deg);
    opacity: 1;
    filter: brightness(2);
  }
  70% {
    transform: scale(0.9) rotate(-3deg);
    filter: brightness(1.3);
  }
  100% {
    transform: scale(1) rotate(0);
    filter: brightness(1);
  }
}

/* å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.evolve-glow {
  box-shadow: 0 0 40px 20px rgba(255,255,255,0.8);
  border-radius: 50%;
}


</style>
</head>
<body>

<audio id="bgm" src="bgm.mp3" loop></audio>


<div class="container">
  <h1>Yell Egg ğŸ¥š</h1>
  <div class="menu">
  <button onclick="showAbout()">ğŸ¥š ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</button>
  <button onclick="showHow()">ğŸ“£ ã‚ãã³ã‹ãŸ</button>
  <button onclick="location.href='collection.html'">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</button>
</div>

<div id="about" style="display:none" class="card">
  <h2>ğŸ¥š ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</h2>
  <p>
    Yell Egg ã¯ã€å¤¢ã«æŒ‘æˆ¦ã—ã¦ã„ã‚‹äººã‚„é ‘å¼µã£ã¦ã‚‹äººã®æŠ•ç¨¿ã«ã‚¨ãƒ¼ãƒ«ã‚’é€ã£ã¦<br>
    åµã‚’é³¥ã«é€²åŒ–ã•ã›ã¿ã‚“ãªã‚’ãƒãƒƒãƒ”ãƒ¼ã«ã™ã‚‹ã‚µã‚¤ãƒˆã§ã™ã€‚
  </p>
</div>

<div id="how" style="display:none" class="card">
  <h2>ğŸ“£ ã‚ãã³ã‹ãŸ</h2>
  <ol style="text-align:left">
    <li>é ‘å¼µã£ã¦ã‚‹ç”»åƒã‚„å‹•ç”»ã‚’æŠ•ç¨¿ã™ã‚‹</li>
    <li>ã‚¨ãƒ¼ãƒ«ã‚’é€ã£ã¦ã‚‚ã‚‰ã†</li>
    <li>ã‚¨ãƒ¼ãƒ«ãŒãŸã¾ã‚‹ã¨åµãŒé³¥ã«é€²åŒ–ï¼</li>
    <li>é³¥ã‚’ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã—ã‚ˆã†</li>
  </ol>
</div>

  <div id="app" style="display:none">
    <input type="file" id="file" accept="image/*,video/*">
    <br><br>
    <button id="post">æŠ•ç¨¿ã™ã‚‹</button>
    <button onclick="location.href='collection.html'">
   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
</button>
    <div id="collection" style="display:none"></div>
    <div id="feed"></div>
  </div>
</div>

<script>
document.addEventListener("click", () => {
  const bgm = document.getElementById("bgm");
  if (bgm && bgm.paused) {
    bgm.volume = 0.3;
    bgm.play();
  }
}, { once: true });
</script>


<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://omabtauqfkswkpyyyttf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYWJ0YXVxZmtzd2tweXl5dHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDQ1MjIsImV4cCI6MjA4MjU4MDUyMn0.sm-zKUJjMz3aJjiKqAUDRwnuJyjwP0FFDO-SvFCBgjQ"
);


/* åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ */
async function ensureAnonUser() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) await supabase.auth.signInAnonymously();
  document.getElementById("app").style.display = "block";
  loadPosts();
}

/* æŠ•ç¨¿ï¼ˆåµã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§1å›ã ã‘æ±ºã‚ã‚‹ï¼‰ */
post.onclick = async () => {
  const f = file.files[0];
  if (!f) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„");

  const { data:{ user } } = await supabase.auth.getUser();
  const path = `${user.id}/${Date.now()}_${f.name}`;

  await supabase.storage.from("media").upload(path, f);
  const { data:{ publicUrl } } =
    supabase.storage.from("media").getPublicUrl(path);

  const eggs = ["red","blue","green","yellow","black"];
  const randomEgg = eggs[Math.floor(Math.random() * eggs.length)];

  await supabase.from("posts").insert({
    user_id: user.id,
    media_url: publicUrl,
    media_type: f.type.startsWith("video") ? "video" : "image",
    egg_type: randomEgg
  });

  file.value = "";
  loadPosts();
};

/* è¡¨ç¤º */
async function loadPosts() {
  const { data: posts } =
    await supabase.from("posts").select("*").order("created_at",{ascending:false});

  feed.innerHTML = "";

  const BASE =
  "https://omabtauqfkswkpyyyttf.supabase.co/storage/v1/object/public/media";

const eggImages = {
  red:   `${BASE}/images/egg_red.png`,
  blue:  `${BASE}/images/egg_blue.png`,
  green: `${BASE}/images/egg_green.png`,
  yellow:`${BASE}/images/egg_yellow.png`,
  black: `${BASE}/images/egg_black.png`
};

const birdImages = {
  red:    `${BASE}/images/bird_red.png`,
  blue:   `${BASE}/images/bird_blue.png`,
  green:  `${BASE}/images/bird_green.png`,
  yellow: `${BASE}/images/bird_yellow.png`,
  black:  `${BASE}/images/bird_black.png`,

  // ğŸ‰ ãƒ•ã‚§ã‚¹é³¥
  fes1: `${BASE}/images/bird_original1.png`,
  fes2: `${BASE}/images/bird_original2.png`,
  fes3: `${BASE}/images/bird_original3.png`
};


  for (const p of posts) {
    const { data: yells } =
      await supabase.from("yells").select("*").eq("post_id", p.id);

    const count = yells.length;
    const isEvolved =count >= 1;
      const image = isEvolved
        ? birdImages[p.egg_type]
        : eggImages[p.egg_type];

    feed.innerHTML += `
      <div class="card">
        ${p.media_type === "video"
          ? `<video src="${p.media_url}" controls muted loop></video>`
          : `<img src="${p.media_url}">`}
        <div class="egg">
          <img 
  src="${image}" 
  class="${isEvolved ? 'evolve evolve-glow' : ''}"
>

        </div>
        <p>${count} / 1</p>
        <button onclick="sendYell('${p.id}')">ã‚¨ãƒ¼ãƒ«ã‚’é€ã‚‹ï¼</button>
      </div>
    `;
  }
}

/* ã‚¨ãƒ¼ãƒ« */
window.sendYell = async (postId) => {
  const { data:{ user } } = await supabase.auth.getUser();
  await supabase.from("yells").insert({
    user_id: user.id,
    post_id: postId
  });
  loadPosts();
};

window.showAbout = () => {
  about.style.display =
    about.style.display === "none" ? "block" : "none";
  how.style.display = "none";
};

window.showHow = () => {
  how.style.display =
    how.style.display === "none" ? "block" : "none";
  about.style.display = "none";
};



ensureAnonUser();
</script>

</body>
</html>
