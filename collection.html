<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Bird Collection</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #f9f9f9;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  max-width: 600px;
  margin: auto;
}

.card {
  background: #fff;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
  cursor: pointer;
}

img {
  width: 100px;
}

/* ===== 演出 ===== */
.viewer {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle, #000 30%, #111);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 999;
}

.viewer video {
  width: 260px;
  max-width: 80%;
  border-radius: 16px;
  box-shadow: 0 0 40px gold;
}

#viewerText {
  color: white;
  margin-top: 20px;
}
</style>
</head>

<body>

<h1>コレクション</h1>
<button onclick="location.href='index.html'">← 戻る</button>
<br><br>

<div id="collection" class="grid"></div>

<div id="viewer" class="viewer" onclick="closeViewer()">
  <video id="viewerVideo" playsinline muted></video>
  <div id="viewerText"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ===== Supabase ===== */
const supabase = createClient(
  "https://omabtauqfkswkpyyyttf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYWJ0YXVxZmtzd2tweXl5dHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDQ1MjIsImV4cCI6MjA4MjU4MDUyMn0.sm-zKUJjMz3aJjiKqAUDRwnuJyjwP0FFDO-SvFCBgjQ"
);

/* ===== 定数 ===== */
const ALL_BIRDS = ["red","blue","green","yellow","black"];
const HAS_MOVIE = ["red","blue","green","yellow"];

const BASE =
  "https://omabtauqfkswkpyyyttf.supabase.co/storage/v1/object/public/media";

const UNKNOWN_IMG = `${BASE}/egg_unknown.png`;

const birdImages = {
  red:    `${BASE}/bird_red.png`,
  blue:   `${BASE}/bird_blue.png`,
  green:  `${BASE}/bird_green.png`,
  yellow: `${BASE}/bird_yellow.png`,
  black:  `${BASE}/bird_black.png`
};

const birdNames = {
  red: "紅焔鳥",
  blue: "蒼波鳥",
  green: "翠癒鳥",
  yellow: "雷光鳥",
  black: "影蘇鳥"
};

/* ===== 認証 ===== */
async function ensureAnonUser() {
  const { data:{ session } } = await supabase.auth.getSession();
  if (!session) await supabase.auth.signInAnonymously();
}

/* ===== コレクション ===== */
async function loadCollection() {
  const { data, error } = await supabase
    .from("posts")
    .select("bird_type");

  if (error) {
    console.error(error);
    return;
  }

  const owned = new Set(
    data.map(p => p.bird_type).filter(Boolean)
  );

  const el = document.getElementById("collection");
  el.innerHTML = "";

  for (const color of ALL_BIRDS) {
    if (owned.has(color)) {
      el.innerHTML += `
        <div class="card" onclick="openViewer('${color}')">
          <img src="${birdImages[color]}">
          <p>${birdNames[color]}</p>
        </div>
      `;
    } else {
      el.innerHTML += `
        <div class="card">
          <img src="${UNKNOWN_IMG}">
          <p>？？？</p>
        </div>
      `;
    }
  }
}

/* ===== 動画演出 ===== */
function openViewer(color) {
  if (!HAS_MOVIE.includes(color)) return;

  const viewer = document.getElementById("viewer");
  const video  = document.getElementById("viewerVideo");
  const text   = document.getElementById("viewerText");

  video.src = `${BASE}/bird_${color}.mp4`;
  video.currentTime = 0;
  video.play();

  text.innerHTML = `
    <strong>${birdNames[color]}</strong><br>
    ✨ スペシャル演出 ✨
  `;

  viewer.style.display = "flex";
}

function closeViewer() {
  const viewer = document.getElementById("viewer");
  const video  = document.getElementById("viewerVideo");

  video.pause();
  video.src = "";
  viewer.style.display = "none";
}

window.openViewer = openViewer;
window.closeViewer = closeViewer;

await ensureAnonUser();
loadCollection();
</script>

</body>
</html>
