<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Bird Collection</title>
<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #f9f9f9;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  max-width: 600px;
  margin: auto;
}

.card {
  background: #fff;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
}

img {
  width: 100px;
}
</style>
</head>
<body>

<h1>コレクション</h1>
<button onclick="location.href='index.html'">← 戻る</button>

<br><br>

<div id="collection" class="grid"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://omabtauqfkswkpyyyttf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYWJ0YXVxZmtzd2tweXl5dHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDQ1MjIsImV4cCI6MjA4MjU4MDUyMn0.sm-zKUJjMz3aJjiKqAUDRwnuJyjwP0FFDO-SvFCBgjQ"
);

// 図鑑に載る全鳥
const allBirds = ["red", "blue", "green", "yellow", "black"];

// 画像
const birdImages = {
  red: "bird_red.png",
  blue: "bird_blue.png",
  green: "bird_green.png",
  yellow: "bird_yellow.png",
  black: "bird_black.png"
};

// 名前
const birdNames = {
  red: "紅焔鳥",
  blue: "蒼波鳥",
  green: "翠癒鳥",
  yellow: "雷光鳥",
  black: "影蘇鳥"
};

// ストーリー
const birdStories = {
  red: "強い応援で生まれた情熱の鳥",
  blue: "仲間の声を静かに受け止める鳥",
  green: "失敗を成長に変える癒しの鳥",
  yellow: "挑戦を続ける者に舞い降りる鳥",
  black: "何度倒れても蘇る不死の鳥"
};

async function ensureAnonUser() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    await supabase.auth.signInAnonymously();
  }
}

async function loadCollection() {
  const { data: posts } =
    await supabase.from("posts").select("*");

  const owned = new Set();

  for (const p of posts) {
    const { data: yells } =
      await supabase.from("yells").select("*").eq("post_id", p.id);

    if (yells.length >= 1 && p.egg_type) {
      owned.add(p.egg_type);
    }
  }

  collection.innerHTML = "";

  for (const color of allBirds) {
    if (owned.has(color)) {
      collection.innerHTML += `
        <div class="card">
          <img src="${birdImages[color]}">
          <h3>${birdNames[color]}</h3>
          <p>${birdStories[color]}</p>
        </div>
      `;
    } else {
      collection.innerHTML += `
        <div class="card">
          <img src="unknown.png">
          <h3>？？？</h3>
          <p>未発見！？</p>
        </div>
      `;
    }
  }
}

await ensureAnonUser();
loadCollection();
</script>

</body>
</html>
