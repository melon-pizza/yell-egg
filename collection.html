<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Bird Collection</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #f9f9f9;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  max-width: 600px;
  margin: auto;
}

.card {
  background: #fff;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
  cursor: pointer;
}

img {
  width: 100px;
}

/* ===== æ¼”å‡ºãƒ“ãƒ¥ãƒ¼ ===== */
.viewer {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle, #000 30%, #111);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 999;
}

.viewer video {
  width: 260px;
  max-width: 80%;
  border-radius: 16px;
  box-shadow: 0 0 40px gold;
}

#viewerText {
  color: white;
  margin-top: 20px;
  font-size: 18px;
}
</style>
</head>

<body>

<h1>ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h1>
<button onclick="location.href='index.html'">â† æˆ»ã‚‹</button>
<br><br>

<div id="collection" class="grid"></div>

<!-- æ¼”å‡ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="viewer" class="viewer" onclick="closeViewer()">
  <video id="viewerVideo" playsinline muted></video>
  <div id="viewerText"></div>
</div>

<script type="module">
console.log("JS is running");

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://omabtauqfkswkpyyyttf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYWJ0YXVxZmtzd2tweXl5dHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDQ1MjIsImV4cCI6MjA4MjU4MDUyMn0.sm-zKUJjMz3aJjiKqAUDRwnuJyjwP0FFDO-SvFCBgjQ"
);

const allBirds = ["red", "blue", "green", "yellow", "black"];

// ğŸ¬ å‹•ç”»ãŒã‚ã‚‹è‰²ã ã‘
const movieBirds = ["red", "blue", "green", "yellow"];

const birdImages = {
  red: "bird_red.png",
  blue: "bird_blue.png",
  green: "bird_green.png",
  yellow: "bird_yellow.png",
  black: "bird_black.png"
};

const birdNames = {
  red: "ç´…ç„”é³¥",
  blue: "è’¼æ³¢é³¥",
  green: "ç¿ ç™’é³¥",
  yellow: "é›·å…‰é³¥",
  black: "å½±è˜‡é³¥"
};

async function ensureAnonUser() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) await supabase.auth.signInAnonymously();
}

async function loadCollection() {
  const { data: posts } = await supabase.from("posts").select("*");
  const owned = new Set();

  for (const p of posts) {
    const { data: yells } =
      await supabase.from("yells").select("*").eq("post_id", p.id);

    if (yells.length >= 1 && p.egg_type) {
      owned.add(p.egg_type);
    }
  }

  const el = document.getElementById("collection");
  el.innerHTML = "";

  for (const color of allBirds) {
    if (owned.has(color)) {
      el.innerHTML += `
        <div class="card" onclick="openViewer('${color}')">
          <img src="${birdImages[color]}">
          <h3>${birdNames[color]}</h3>
        </div>
      `;
    } else {
      el.innerHTML += `
        <div class="card">
          <img src="unknown.png">
          <h3>ï¼Ÿï¼Ÿï¼Ÿ</h3>
        </div>
      `;
    }
  }
}

/* ===== æ¼”å‡º ===== */
function openViewer(color) {
  const viewer = document.getElementById("viewer");
  const video = document.getElementById("viewerVideo");
  const text = document.getElementById("viewerText");

  // åˆæœŸåŒ–
  video.pause();
  video.src = "";

  if (movieBirds.includes(color)) {
    // ğŸ¬ å‹•ç”»ã‚ã‚Š
    const VIDEO_BASE =
  "https://omabtauqfkswkpyyyttf.supabase.co/storage/v1/object/public/media/movies";
    video.src = `${VIDEO_BASE}/bird_${color}_movie.mp4`;
    video.currentTime = 0;
    video.play();

    text.innerHTML = `
      <strong>${birdNames[color]}</strong><br>
      <span style="color:gold">âœ¨ ã‚¹ãƒšã‚·ãƒ£ãƒ«æ¼”å‡º âœ¨</span>
    `;
  } else {
    // âš« å‹•ç”»ãªã—ï¼ˆblackï¼‰
    const HAS_MOVIE = ["red","blue","green","yellow"];

function openViewer(color) {
  if (!HAS_MOVIE.includes(color)) {
    alert("ã“ã®é³¥ã¯ã¾ã æ¼”å‡ºå‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  const video = document.getElementById("viewerVideo");
  video.src = `${VIDEO_BASE}/bird_${color}_movie.mp4`;
  video.currentTime = 0;
  video.play();
  viewer.style.display = "flex";
}

    text.innerHTML = `
      <strong>${birdNames[color]}</strong><br>
      <span style="color:#aaa">ã¾ã ç‰¹åˆ¥æ¼”å‡ºã¯æº–å‚™ä¸­â€¦</span>
    `;
  }

  viewer.style.display = "flex";
}

function closeViewer() {
  const viewer = document.getElementById("viewer");
  const video = document.getElementById("viewerVideo");

  video.pause();
  video.src = "";
  viewer.style.display = "none";
}

window.openViewer = openViewer;
window.closeViewer = closeViewer;

await ensureAnonUser();
loadCollection();
</script>

</body>
</html>
