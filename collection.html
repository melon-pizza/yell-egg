<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Bird Collection</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #f9f9f9;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  max-width: 600px;
  margin: auto;
}

.card {
  background: #fff;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
  cursor: pointer;
}

img {
  width: 100px;
}

/* ===== 演出ビュー ===== */
.viewer {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle, #000 30%, #111);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 999;
}

.viewer video {
  width: 260px;
  max-width: 80%;
  border-radius: 16px;
  box-shadow: 0 0 40px gold;
}

#viewerText {
  color: white;
  margin-top: 20px;
  font-size: 18px;
}
</style>
</head>

<body>

<h1>コレクション</h1>
<button onclick="location.href='index.html'">← 戻る</button>
<br><br>

<div id="collection" class="grid"></div>

<!-- 演出 -->
<div id="viewer" class="viewer" onclick="closeViewer()">
  <video id="viewerVideo" playsinline muted></video>
  <div id="viewerText"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const allBirds = ["red","blue","green","yellow","black"];

const supabase = createClient(
  "https://omabtauqfkswkpyyyttf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tYWJ0YXVxZmtzd2tweXl5dHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMDQ1MjIsImV4cCI6MjA4MjU4MDUyMn0.sm-zKUJjMz3aJjiKqAUDRwnuJyjwP0FFDO-SvFCBgjQ"
);

/* ===== 設定 ===== */
const ALL_BIRDS = ["red","blue","green","yellow","black"];

const HAS_MOVIE = ["red","blue","green","yellow"];

const BASE =
"https://omabtauqfkswkpyyyttf.supabase.co/storage/v1/object/public/media";

const birdImages = {
  red: `${BASE}/images/bird_red.png`,
  blue: `${BASE}/images/bird_blue.png`,
  green: `${BASE}/images/bird_green.png`,
  yellow: `${BASE}/images/bird_yellow.png`,
  black: `${BASE}/images/bird_black.png`
};

const birdNames = {
  red: "紅焔鳥",
  blue: "蒼波鳥",
  green: "翠癒鳥",
  yellow: "雷光鳥",
  black: "影蘇鳥"
};

const VIDEO_BASE = `${BASE}/movies`;

/* ===== 認証 ===== */
async function ensureAnonUser() {
  const { data:{ session } } = await supabase.auth.getSession();
  if (!session) await supabase.auth.signInAnonymously();
}

/* ===== コレクション読込 ===== */
async function loadCollection() {
  const { data, error } = await supabase
    .from("posts")
    .select("bird_type");

  if (error) {
    console.error("posts取得エラー", error);
    return;
  }

  if (!data) {
    console.warn("posts が null です");
    return;
  }

  const owned = new Set(
    data
      .map(p => p.bird_type)
      .filter(Boolean)
  );

  const el = document.getElementById("collection");
  el.innerHTML = "";

  for (const color of allBirds) {
    if (owned.has(color)) {
      el.innerHTML += `
        <div class="card">
          <img src="${birdImages[color]}">
          <h3>${birdNames[color]}</h3>
        </div>
      `;
    } else {
      el.innerHTML += `
        <div class="card">
          <img src="${UNKNOWN_IMG}">
          <h3>？？？</h3>
        </div>
      `;
    }
  }
}


/* ===== 演出 ===== */
function openViewer(color) {
  const viewer = document.getElementById("viewer");
  const video = document.getElementById("viewerVideo");
  const text = document.getElementById("viewerText");

  video.pause();
  video.src = "";

  if (HAS_MOVIE.includes(color)) {
    video.src = `${VIDEO_BASE}/bird_${color}_movie.mp4`;
    video.currentTime = 0;
    video.play();

    text.innerHTML = `
      <strong>${birdNames[color]}</strong><br>
      <span style="color:gold">✨ スペシャル演出 ✨</span>
    `;
  } else {
    text.innerHTML = `
      <strong>${birdNames[color]}</strong><br>
      <span style="color:#aaa">まだ演出動画はありません</span>
    `;
  }

  viewer.style.display = "flex";
}

function closeViewer() {
  const viewer = document.getElementById("viewer");
  const video = document.getElementById("viewerVideo");

  video.pause();
  video.src = "";
  viewer.style.display = "none";
}

window.openViewer = openViewer;
window.closeViewer = closeViewer;

await ensureAnonUser();
loadCollection();
</script>

</body>
</html>
